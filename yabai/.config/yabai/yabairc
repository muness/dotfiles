#!/usr/bin/env sh

# Remove existing signals (in case of restart)
yabai -m signal --remove "sketchybar_space_change" 2>/dev/null
yabai -m signal --remove "sketchybar_front_app" 2>/dev/null

yabai -m signal --add event=space_changed action="sketchybar --trigger space_change" label="sketchybar_space_change"
yabai -m signal --add event=window_focused action="sketchybar --trigger front_app_switched" label="sketchybar_front_app"
yabai -m signal --add event=dock_did_restart action="brew services restart sketchybar"
brew services restart sketchybar


# ---------- Process Management ----------
# Kill instances of borders to prevent duplicates on config reload
killall borders 2>/dev/null

# ---------- Core tiling ----------
yabai -m config layout bsp
yabai -m config split_type auto
yabai -m config auto_balance on
yabai -m config window_placement second_child

# ---------- Look and feel ----------
yabai -m config top_padding 10
yabai -m config bottom_padding 10
yabai -m config left_padding 10
yabai -m config right_padding 10
yabai -m config window_gap 10
yabai -m config external_bar all:25:0

# Disable macOS window shadows (cleaner look with borders)
yabai -m config window_shadow off

# ---------- Ghostty Compatibility ----------
# Force a layout refresh when Ghostty windows/tabs are created or destroyed
# This prevents "ghost" tiles when using native macOS tabs (Cmd+T) inside Ghostty
yabai -m signal --add app='^Ghostty$' event=window_created action='yabai -m space --layout bsp'
yabai -m signal --add app='^Ghostty$' event=window_destroyed action='yabai -m space --layout bsp'

# ---------- Mouse driven control ----------
yabai -m config mouse_modifier fn
yabai -m config mouse_action1 move
yabai -m config mouse_action2 resize
yabai -m config mouse_drop_action swap
yabai -m config focus_follows_mouse off
yabai -m config mouse_follows_focus off

# ---------- Float some apps ----------
# Standard system apps that break when tiled
yabai -m rule --add app="^System Settings$" manage=off
yabai -m rule --add app="^App Store$" manage=off
yabai -m rule --add app="^Finder$" manage=off
yabai -m rule --add app="^Messages$" manage=off
yabai -m rule --add app="^Calendar$" manage=off
yabai -m rule --add app="^Calculator$" manage=off
yabai -m rule --add app="^Raycast$" manage=off

# ---------- Start External Tools ----------
# JankyBorders configuration
# Note: Ensure you have JankyBorders installed via brew
borders active_color="gradient(top_right=0xfffab387,bottom_left=0xfff38ba8)" \
        inactive_color=0xff494d64 \
        width=6.0 &

echo "yabai configuration loaded"
